<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Overview</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f4f4f4;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            position: relative;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #28A745;
            color: white;
            z-index: 2;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        select, input {
            margin-bottom: 10px;
            padding: 5px;
        }
        .summary {
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        canvas {
            max-width: 600px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Town Budget Overview</h1>
    <div class="summary">
        <h3>Summary</h3>
        <p><strong>Total FY25 Requested:</strong> <span id="totalRequested">Loading...</span></p>
        <p><strong>Total FY26 Proposed:</strong> <span id="totalProposed">Loading...</span></p>
        <p><strong>Average Percent Change:</strong> <span id="avgChange">Loading...</span></p>
    </div>
    <canvas id="budgetChart"></canvas>
    <label for="departmentFilter">Filter by Department:</label>
    <select id="departmentFilter" onchange="filterTable()">
        <option value="">All</option>
    </select>
    <label for="subcategoryFilter">Filter by Subcategory:</label>
    <input type="text" id="subcategoryFilter" onkeyup="filterTable()" placeholder="Type to filter...">
    <table id="budgetTable">
        <thead>
            <tr>
                <th>Department</th>
                <th>Request</th>
                <th>FY24 Actual</th>
                <th>FY25 Requested</th>
                <th>FY25 Actual</th>
                <th>FY26 Dept</th>
                <th>FY26 Proposed</th>
                <th>Dollar Change</th>
                <th>Percent Change</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data Rows Will Be Populated Dynamically -->
        </tbody>
    </table>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetch('budget-data.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('CSV file not found or inaccessible.');
                    }
                    return response.text();
                })
                .then(csvData => {
                    if (!csvData) {
                        console.error('CSV file is empty.');
                        return;
                    }
                    const rows = csvData.trim().split('\n').map(row => row.split(','));
                    if (rows.length < 2) {
                        console.error('CSV file does not contain enough data.');
                        return;
                    }
                    const headers = rows.shift();
                    const data = rows.map(row => {
                        return {
                            Department: row[0] || '',
                            Request: (row[1] || '').replace(/Total/gi, '').trim(),
                            FY24_ACTUAL: parseFloat(row[2]) || 0,
                            FY25_REQUESTED: parseFloat(row[3]) || 0,
                            FY25_ACTUAL: parseFloat(row[4]) || 0,
                            FY26_DEPT: row[5] || '',
                            FY26_PROPOSED: parseFloat(row[6]) || 0,
                            Dollar_Change: parseFloat(row[7]) || 0,
                            Percent_Change: parseFloat(row[8]) || 0
                        };
                    });
                    
                    const tableBody = document.querySelector("#budgetTable tbody");
                    const departmentFilter = document.querySelector("#departmentFilter");
                    const departments = new Set();
                    let totalRequested = 0;
                    let totalProposed = 0;
                    let departmentTotals = {};
                    
                    function populateTable(filteredData = data) {
                        tableBody.innerHTML = "";
                        totalRequested = 0;
                        totalProposed = 0;
                        departmentTotals = {};
                        
                        filteredData.forEach(row => {
                            totalRequested += row.FY25_REQUESTED;
                            totalProposed += row.FY26_PROPOSED;
                            if (!departmentTotals[row.Department]) {
                                departmentTotals[row.Department] = { FY25: 0, FY26: 0 };
                            }
                            departmentTotals[row.Department].FY25 += row.FY25_REQUESTED;
                            departmentTotals[row.Department].FY26 += row.FY26_PROPOSED;
                            
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row.Department}</td>
                                <td>${row.Request}</td>
                                <td>$${row.FY24_ACTUAL.toFixed(2)}</td>
                                <td>$${row.FY25_REQUESTED.toFixed(2)}</td>
                                <td>$${row.FY25_ACTUAL.toFixed(2)}</td>
                                <td>${row.FY26_DEPT}</td>
                                <td>$${row.FY26_PROPOSED.toFixed(2)}</td>
                                <td>$${row.Dollar_Change.toFixed(2)}</td>
                                <td>${row.Percent_Change.toFixed(2)}%</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                        document.getElementById("totalRequested").textContent = `$${totalRequested.toFixed(2)}`;
                        document.getElementById("totalProposed").textContent = `$${totalProposed.toFixed(2)}`;
                    }
                    
                    populateTable();
                })
                .catch(error => console.error('Error loading CSV file:', error.message));
        });
    </script>
</body>
</html>
